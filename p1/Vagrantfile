SERVER_IP = "192.168.56.110"
WORKER_IP = "192.168.56.111"

SERVER_HOSTNAME = "emaugaleS"
SERVER_TOKEN_PATH = "/vagrant/server-token" 
SERVER_PUBLIC_TOKEN = "/var/lib/rancher/k3s/server/token"
WORKER_HOSTNAME = "emaugaleSW"

IMAGE = "generic/alpine38"
K3S_INSTALL = "https://get.k3s.io"

MEMORY = "2048"
CPUS = 2 

Vagrant.configure("2") do |config|

        config.vm.box = IMAGE
        config.vm.provider "virtualbox" do |vb|
            vb.memory = "2048"
            vb.cpus = 2
        end
            config.vm.synced_folder '.', '/vagrant', disabled: true # sinon ca marche pas avec WSL (A RETIRER SI PAS WSL)
    
        config.vm.define "server" do |server|
            server.vm.hostname = SERVER_HOSTNAME
            server.vm.network "private_network", ip: SERVER_IP

            server.vm.provision "shell" do |s|
                s.env = {
                    "INSTALL_K3S_EXEC" => "--flannel-iface=eth1",
                    "K3S_CUBECONFIG_MODE" => "644"      
                }
                s.path = "https://get.k3s.io"
            end
            
            server.vm.provision "shell" do |s|  
                s.args = [SERVER_TOKEN_PATH, SERVER_PUBLIC_TOKEN]
                s.inline = "cp $1 $2 ; chown vagrant:vagrant $2"
            end
            server.vm.provision "shell", inline: "firewall-cmd --add-port=6443/tcp"
        end


        config.vm.define "worker" do |worker|
            worker.vm.hostname = WORKER_HOSTNAME
            worker.vm.network "private_network", ip: WORKER_IP
            
            # install k3s on worker machine 
            worker.vm.provision "shell", inline: <<-SHELL
                apk add curl
                curl -sfL get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig=/home/ubuntu/.kube/config --write-kubeconfig-mode=644" sh -
                SHELL
            end
        end
    